{% extends "base.html" %}

{% block title %}Account Information{% endblock %}

{% block content %}
<h1 class="section-title">Account Information</h1>

<div class="card">
    <div id="accountInfo">
        <div class="spinner"></div>
    </div>
</div>

<div id="passwordChangeForm" class="card hidden">
    <h3 style="margin-bottom: 20px;">Change Password</h3>
    <form onsubmit="changePassword(event)">
        <div class="form-group">
            <label>Current Password</label>
            <input type="password" id="currentPassword" required>
        </div>
        <div class="form-group">
            <label>New Password (min 8 characters)</label>
            <input type="password" id="newPassword" minlength="8" required>
        </div>
        <div class="form-group">
            <label>Confirm New Password</label>
            <input type="password" id="confirmPassword" minlength="8" required>
        </div>
        <div class="flex gap-10">
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i> Save Password
            </button>
            <button type="button" class="btn btn-secondary" onclick="hidePasswordForm()">
                <i class="fas fa-times"></i> Cancel
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
    async function loadAccountView() {
        try {
            const response = await fetch('/api/account');
            const data = await response.json();

            const html = `
                <div style="display: grid; gap: 15px;">
                    <div style="display: flex; justify-content: space-between; padding: 15px; background: #f8fafc; border-radius: 8px;">
                        <strong style="color: #475569;">Name:</strong>
                        <span>${data.name}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 15px; background: #f8fafc; border-radius: 8px;">
                        <strong style="color: #475569;">User ID:</strong>
                        <span>${data.user_id}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 15px; background: #f8fafc; border-radius: 8px;">
                        <strong style="color: #475569;">Username:</strong>
                        <span>${data.username}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 15px; background: #f8fafc; border-radius: 8px;">
                        <strong style="color: #475569;">Role:</strong>
                        <span class="badge badge-primary">${data.role}</span>
                    </div>
                    ${data.class ? `
                    <div style="display: flex; justify-content: space-between; padding: 15px; background: #f8fafc; border-radius: 8px;">
                        <strong style="color: #475569;">Class:</strong>
                        <span>${data.class}</span>
                    </div>
                    ` : ''}
                    ${data.subjects ? `
                    <div style="display: flex; justify-content: space-between; padding: 15px; background: #f8fafc; border-radius: 8px;">
                        <strong style="color: #475569;">Subjects:</strong>
                        <span>${data.subjects}</span>
                    </div>
                    ` : ''}
                </div>
                <button onclick="showChangePasswordForm()" class="btn btn-primary mt-20">
                    <i class="fas fa-key"></i> Change Password
                </button>
            `;

            document.getElementById('accountInfo').innerHTML = html;
        } catch (error) {
            document.getElementById('accountInfo').innerHTML = '<p style="color: #ef4444;">Failed to load account information</p>';
        }
    }

    function showChangePasswordForm() {
        document.getElementById('passwordChangeForm').classList.remove('hidden');
        window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    }

    function hidePasswordForm() {
        document.getElementById('passwordChangeForm').classList.add('hidden');
        document.getElementById('currentPassword').value = '';
        document.getElementById('newPassword').value = '';
        document.getElementById('confirmPassword').value = '';
    }

    async function changePassword(event) {
        event.preventDefault();

        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        if (newPassword !== confirmPassword) {
            alert('New passwords do not match!');
            return;
        }

        if (newPassword.length < 8) {
            alert('Password must be at least 8 characters!');
            return;
        }

        try {
            const response = await fetch('/api/change-password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    current_password: currentPassword,
                    new_password: newPassword
                })
            });

            const data = await response.json();

            if (response.ok) {
                alert('Password changed successfully! You will now be logged out.');
                window.location.href = '/logout';
            } else {
                alert(data.error || 'Failed to change password');
            }
        } catch (error) {
            alert('Error changing password. Please try again.');
        }
    }

    // Load on page load
    loadAccountView();
</script>
{% endblock %}