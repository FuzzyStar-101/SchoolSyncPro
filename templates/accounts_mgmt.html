{% extends "base.html" %}

{% block title %}Accounts Management{% endblock %}

{% block content %}
<div class="flex-between mb-20">
    <h1 class="section-title" style="margin-bottom: 0;">Accounts Management</h1>
    <button onclick="showAddAccountForm()" class="btn btn-primary">
        <i class="fas fa-user-plus"></i> Add Account
    </button>
</div>

<div id="addAccountForm" class="card hidden">
    <h3 style="margin-bottom: 20px;">Add New Account</h3>
    <form onsubmit="addAccount(event)">
        <div class="form-grid">
            <div class="form-group">
                <label>Name *</label>
                <input type="text" id="accName" required>
            </div>
            <div class="form-group">
                <label>Username *</label>
                <input type="text" id="accUsername" required>
            </div>
            <div class="form-group">
                <label>Password *</label>
                <input type="password" id="accPassword" minlength="8" required>
            </div>
            <div class="form-group">
                <label>Role *</label>
                <select id="accRole" onchange="toggleRoleFields()" required>
                    <option value="student">Student</option>
                    <option value="teacher">Teacher</option>
                    <option value="admin">Admin</option>
                </select>
            </div>
            <div class="form-group" id="classField">
                <label>Class</label>
                <input type="text" id="accClass">
            </div>
            <div class="form-group" id="subjectsField" style="display: none;">
                <label>Subjects (comma-separated)</label>
                <input type="text" id="accSubjects" placeholder="Math, Physics, Chemistry">
            </div>
        </div>
        <div class="flex gap-10 mt-20">
            <button type="submit" class="btn btn-success">
                <i class="fas fa-save"></i> Create Account
            </button>
            <button type="button" class="btn btn-secondary" onclick="hideAddAccountForm()">
                <i class="fas fa-times"></i> Cancel
            </button>
        </div>
    </form>
</div>

<!-- Tab Buttons -->
<div class="card" style="padding: 15px; margin-bottom: 20px;">
    <div class="flex gap-10">
        <button onclick="showAccountType('students')" id="btnStudents" class="btn btn-primary">
            <i class="fas fa-user-graduate"></i> Students
        </button>
        <button onclick="showAccountType('teachers')" id="btnTeachers" class="btn btn-secondary">
            <i class="fas fa-chalkboard-teacher"></i> Teachers
        </button>
        {% if user.role == 'superadmin' %}
        <button onclick="showAccountType('admins')" id="btnAdmins" class="btn btn-secondary">
            <i class="fas fa-user-shield"></i> Admins
        </button>
        {% endif %}
    </div>
</div>

<!-- Tables -->
<div class="card">
    <div id="studentsTable">
        <div class="spinner"></div>
    </div>
    <div id="teachersTable" style="display: none;"></div>
    <div id="adminsTable" style="display: none;"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let allAccounts = [];

    async function loadAccountsView() {
        try {
            const response = await fetch('/api/admin/accounts');
            allAccounts = await response.json();
            showAccountType('students');
        } catch (error) {
            document.getElementById('studentsTable').innerHTML = '<p style="color: #ef4444;">Failed to load accounts</p>';
        }
    }

    function showAccountType(type) {
        // Update button styles
        document.querySelectorAll('[id^="btn"]').forEach(btn => {
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-secondary');
        });
        document.getElementById('btn' + type.charAt(0).toUpperCase() + type.slice(1)).classList.remove('btn-secondary');
        document.getElementById('btn' + type.charAt(0).toUpperCase() + type.slice(1)).classList.add('btn-primary');

        // Hide all tables
        document.getElementById('studentsTable').style.display = 'none';
        document.getElementById('teachersTable').style.display = 'none';
        document.getElementById('adminsTable').style.display = 'none';

        // Show selected table
        const targetTable = type + 'Table';
        document.getElementById(targetTable).style.display = 'block';

        // Filter and render
        let filtered = [];
        if (type === 'students') {
            filtered = allAccounts.filter(acc => acc.role === 'student');
        } else if (type === 'teachers') {
            filtered = allAccounts.filter(acc => acc.role === 'teacher');
        } else if (type === 'admins') {
            filtered = allAccounts.filter(acc => acc.role === 'admin' || acc.role === 'superadmin');
        }

        let html = '<table><thead><tr>';
        html += '<th>ID</th><th>Name</th><th>Username</th>';
        
        if (type === 'students') {
            html += '<th>Class</th>';
        } else if (type === 'teachers') {
            html += '<th>Subjects</th>';
        }
        
        html += '<th>Actions</th></tr></thead><tbody>';

        filtered.forEach(acc => {
            html += `<tr>
                <td>${acc.user_id}</td>
                <td>${acc.name}</td>
                <td>${acc.username}</td>`;
            
            if (type === 'students') {
                html += `<td>${acc.class || '-'}</td>`;
            } else if (type === 'teachers') {
                html += `<td>${acc.subjects || '-'}</td>`;
            }
            
            html += `<td>
                <button onclick="resetUserPassword('${acc.user_id}')" class="btn btn-primary" style="padding: 8px 12px; margin-right: 5px;">
                    <i class="fas fa-key"></i>
                </button>
                <button onclick="deleteAccount('${acc.user_id}')" class="btn btn-danger" style="padding: 8px 12px;">
                    <i class="fas fa-trash"></i>
                </button>
            </td></tr>`;
        });

        html += '</tbody></table>';

        if (filtered.length === 0) {
            html = `<div class="text-center" style="padding: 40px;">
                <i class="fas fa-users" style="font-size: 64px; color: #cbd5e1; margin-bottom: 20px;"></i>
                <h3 style="color: #64748b;">No ${type} found</h3>
            </div>`;
        }

        document.getElementById(targetTable).innerHTML = html;
    }

    function showAddAccountForm() {
        document.getElementById('addAccountForm').classList.remove('hidden');
        toggleRoleFields();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function hideAddAccountForm() {
        document.getElementById('addAccountForm').classList.add('hidden');
        document.getElementById('accName').value = '';
        document.getElementById('accUsername').value = '';
        document.getElementById('accPassword').value = '';
        document.getElementById('accRole').value = 'student';
        document.getElementById('accClass').value = '';
        document.getElementById('accSubjects').value = '';
    }

    function toggleRoleFields() {
        const role = document.getElementById('accRole').value;
        
        if (role === 'student') {
            document.getElementById('classField').style.display = 'block';
            document.getElementById('subjectsField').style.display = 'none';
        } else if (role === 'teacher') {
            document.getElementById('classField').style.display = 'none';
            document.getElementById('subjectsField').style.display = 'block';
        } else {
            document.getElementById('classField').style.display = 'none';
            document.getElementById('subjectsField').style.display = 'none';
        }
    }

    async function addAccount(event) {
        event.preventDefault();

        const data = {
            name: document.getElementById('accName').value,
            username: document.getElementById('accUsername').value,
            password: document.getElementById('accPassword').value,
            role: document.getElementById('accRole').value,
            class: document.getElementById('accClass').value,
            subjects: document.getElementById('accSubjects').value
        };

        try {
            const response = await fetch('/api/admin/accounts', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                alert('Account created successfully!');
                hideAddAccountForm();
                loadAccountsView();
            } else {
                const error = await response.json();
                alert(error.error || 'Failed to create account');
            }
        } catch (error) {
            alert('Error creating account');
        }
    }

    async function resetUserPassword(userId) {
        const newPassword = prompt('Enter new password (min 8 characters):');
        
        if (!newPassword) return;
        
        if (newPassword.length < 8) {
            alert('Password must be at least 8 characters');
            return;
        }

        try {
            const response = await fetch('/api/admin/reset-password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: userId, new_password: newPassword })
            });

            if (response.ok) {
                alert('Password reset successfully! User will be prompted to change it on next login.');
            } else {
                alert('Failed to reset password');
            }
        } catch (error) {
            alert('Error resetting password');
        }
    }

    async function deleteAccount(userId) {
        if (!confirm('Are you sure you want to delete this account? This action cannot be undone.')) {
            return;
        }

        try {
            const response = await fetch(`/api/admin/accounts?id=${userId}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                alert('Account deleted successfully!');
                loadAccountsView();
            } else {
                alert('Failed to delete account');
            }
        } catch (error) {
            alert('Error deleting account');
        }
    }

    loadAccountsView();
</script>
{% endblock %}