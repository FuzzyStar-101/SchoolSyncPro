{% extends "base.html" %}

{% block title %}Homework{% endblock %}

{% block content %}
<div class="flex-between mb-20">
    <h1 class="section-title" style="margin-bottom: 0;">Homework</h1>
    {% if user.role in ['teacher', 'admin', 'superadmin'] %}
    <button onclick="showAddHomeworkForm()" class="btn btn-primary">
        <i class="fas fa-plus"></i> Add Homework
    </button>
    {% endif %}
</div>

<div id="addHomeworkForm" class="card hidden">
    <h3 style="margin-bottom: 20px;">Add New Homework</h3>
    <form onsubmit="addHomework(event)">
        <div class="form-grid">
            <div class="form-group">
                <label>Subject</label>
                <input type="text" id="hwSubject" required>
            </div>
            <div class="form-group">
                <label>Class</label>
                <input type="text" id="hwClass" required>
            </div>
            <div class="form-group">
                <label>Title</label>
                <input type="text" id="hwTitle" required>
            </div>
            <div class="form-group">
                <label>Date Given</label>
                <input type="date" id="hwDateGiven" required>
            </div>
            <div class="form-group" style="grid-column: span 2;">
                <label>Due Date</label>
                <input type="date" id="hwDueDate" required>
            </div>
            <div class="form-group" style="grid-column: span 2;">
                <label>Description</label>
                <textarea id="hwDescription" rows="3"></textarea>
            </div>
        </div>
        <div class="flex gap-10 mt-20">
            <button type="submit" class="btn btn-success">
                <i class="fas fa-save"></i> Save Homework
            </button>
            <button type="button" class="btn btn-secondary" onclick="hideAddHomeworkForm()">
                <i class="fas fa-times"></i> Cancel
            </button>
        </div>
    </form>
</div>

<div class="card">
    <div id="homeworkList">
        <div class="spinner"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    async function loadHomeworkView() {
        try {
            const response = await fetch('/api/homework');
            const homework = await response.json();

            if (homework.length === 0) {
                document.getElementById('homeworkList').innerHTML = `
                    <div class="text-center" style="padding: 40px;">
                        <i class="fas fa-book-open" style="font-size: 64px; color: #cbd5e1; margin-bottom: 20px;"></i>
                        <h3 style="color: #64748b;">No homework assigned</h3>
                        <p style="color: #94a3b8; margin-top: 10px;">Check back later for new assignments.</p>
                    </div>
                `;
                return;
            }

            // Sort by due date
            homework.sort((a, b) => new Date(a.due_date) - new Date(b.due_date));

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Subject</th>
                            <th>Title</th>
                            <th>Date Given</th>
                            <th>Due Date</th>
                            <th>Class</th>
                            {% if user.role in ['teacher', 'admin', 'superadmin'] %}
                            <th>Actions</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
            `;

            homework.forEach(hw => {
                const dueDate = new Date(hw.due_date);
                const today = new Date();
                const isOverdue = dueDate < today;
                const dueDateStyle = isOverdue ? 'color: #ef4444; font-weight: 600;' : '';

                html += `
                    <tr>
                        <td>${hw.id}</td>
                        <td><span class="badge badge-primary">${hw.subject}</span></td>
                        <td>${hw.title}</td>
                        <td>${new Date(hw.date_given).toLocaleDateString()}</td>
                        <td style="${dueDateStyle}">${dueDate.toLocaleDateString()}</td>
                        <td>${hw.class}</td>
                        {% if user.role in ['teacher', 'admin', 'superadmin'] %}
                        <td>
                            <button onclick="deleteHomework('${hw.id}')" class="btn btn-danger" style="padding: 8px 12px;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                        {% endif %}
                    </tr>
                `;
            });

            html += '</tbody></table>';

            document.getElementById('homeworkList').innerHTML = html;
        } catch (error) {
            document.getElementById('homeworkList').innerHTML = '<p style="color: #ef4444;">Failed to load homework</p>';
        }
    }

    function showAddHomeworkForm() {
        document.getElementById('addHomeworkForm').classList.remove('hidden');
        // Set today's date as default
        document.getElementById('hwDateGiven').valueAsDate = new Date();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function hideAddHomeworkForm() {
        document.getElementById('addHomeworkForm').classList.add('hidden');
        document.getElementById('hwSubject').value = '';
        document.getElementById('hwClass').value = '';
        document.getElementById('hwTitle').value = '';
        document.getElementById('hwDateGiven').value = '';
        document.getElementById('hwDueDate').value = '';
        document.getElementById('hwDescription').value = '';
    }

    async function addHomework(event) {
        event.preventDefault();

        const data = {
            subject: document.getElementById('hwSubject').value,
            class: document.getElementById('hwClass').value,
            title: document.getElementById('hwTitle').value,
            date_given: document.getElementById('hwDateGiven').value,
            due_date: document.getElementById('hwDueDate').value,
            description: document.getElementById('hwDescription').value
        };

        try {
            const response = await fetch('/api/homework', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                alert('Homework added successfully!');
                hideAddHomeworkForm();
                loadHomeworkView();
            } else {
                alert('Failed to add homework');
            }
        } catch (error) {
            alert('Error adding homework');
        }
    }

    async function deleteHomework(id) {
        if (!confirm('Are you sure you want to delete this homework?')) {
            return;
        }

        try {
            const response = await fetch(`/api/homework?id=${id}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                alert('Homework deleted successfully!');
                loadHomeworkView();
            } else {
                alert('Failed to delete homework');
            }
        } catch (error) {
            alert('Error deleting homework');
        }
    }

    loadHomeworkView();
</script>
{% endblock %}